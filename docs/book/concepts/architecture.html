<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture Overview</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="architecture-overview"><a class="header" href="#architecture-overview">Architecture Overview</a></h1>
<p>This page provides a detailed overview of Bindy's architecture and design principles.</p>
<h2 id="high-level-architecture"><a class="header" href="#high-level-architecture">High-Level Architecture</a></h2>
<pre><code>┌──────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                        │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            Custom Resource Definitions (CRDs)          │ │
│  │  • Bind9Instance  • DNSZone  • ARecord  • MXRecord ... │ │
│  └────────────────────────────────────────────────────────┘ │
│                             │                                │
│                             │ watches                        │
│                             ▼                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Bindy Controller (Rust)                   │ │
│  │                                                        │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │ │
│  │  │  Bind9Instance│  │   DNSZone    │  │   Records   │ │ │
│  │  │  Reconciler  │  │  Reconciler  │  │  Reconciler │ │ │
│  │  └──────────────┘  └──────────────┘  └─────────────┘ │ │
│  │                                                        │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │         Zone File Generator                      │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────┘ │
│                             │                                │
│                             │ configures                     │
│                             ▼                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              BIND9 Instances                           │ │
│  │                                                        │ │
│  │  ┌──────────┐      ┌──────────┐      ┌──────────┐    │ │
│  │  │ Primary  │ AXFR │Secondary │ AXFR │Secondary │    │ │
│  │  │   DNS    │─────▶│   DNS    │─────▶│   DNS    │    │ │
│  │  │  (us-east)│     │ (us-west)│     │  (eu)    │    │ │
│  │  └──────────┘      └──────────┘      └──────────┘    │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                             │
                             │ DNS queries (UDP/TCP 53)
                             ▼
                    ┌─────────────────┐
                    │     Clients     │
                    │  • Apps         │
                    │  • Services     │
                    │  • External     │
                    └─────────────────┘
</code></pre>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<h3 id="bindy-controller"><a class="header" href="#bindy-controller">Bindy Controller</a></h3>
<p>The controller is written in Rust using the kube-rs library. It consists of:</p>
<h4 id="1-reconcilers"><a class="header" href="#1-reconcilers">1. Reconcilers</a></h4>
<p>Each reconciler handles a specific resource type:</p>
<ul>
<li>
<p><strong>Bind9Instance Reconciler</strong> - Manages BIND9 instance lifecycle</p>
<ul>
<li>Creates StatefulSets for BIND9 pods</li>
<li>Configures services and networking</li>
<li>Updates instance status</li>
</ul>
</li>
<li>
<p><strong>DNSZone Reconciler</strong> - Manages DNS zones</p>
<ul>
<li>Evaluates label selectors</li>
<li>Generates zone files</li>
<li>Updates zone configuration</li>
<li>Reports matched instances</li>
</ul>
</li>
<li>
<p><strong>Record Reconcilers</strong> - Manage individual DNS records</p>
<ul>
<li>One reconciler per record type (A, AAAA, CNAME, MX, TXT, NS, SRV, CAA)</li>
<li>Validates record specifications</li>
<li>Appends records to zone files</li>
<li>Updates record status</li>
</ul>
</li>
</ul>
<h4 id="2-zone-file-generator"><a class="header" href="#2-zone-file-generator">2. Zone File Generator</a></h4>
<p>Generates BIND9-compatible zone files from Kubernetes resources:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Simplified example
pub fn generate_zone_file(zone: &amp;DNSZone, records: Vec&lt;DNSRecord&gt;) -&gt; String {
    let mut zone_file = String::new();

    // SOA record
    zone_file.push_str(&amp;format_soa_record(&amp;zone.spec.soa_record));

    // NS records
    for ns in &amp;zone.spec.name_servers {
        zone_file.push_str(&amp;format_ns_record(ns));
    }

    // Individual records
    for record in records {
        zone_file.push_str(&amp;format_record(record));
    }

    zone_file
}
<span class="boring">}</span></code></pre></pre>
<h3 id="custom-resource-definitions-crds"><a class="header" href="#custom-resource-definitions-crds">Custom Resource Definitions (CRDs)</a></h3>
<p>CRDs define the schema for DNS resources:</p>
<pre><code class="language-yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: dnszones.bindy.firestoned.io
spec:
  group: bindy.firestoned.io
  names:
    kind: DNSZone
    plural: dnszones
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
</code></pre>
<h3 id="bind9-instances"><a class="header" href="#bind9-instances">BIND9 Instances</a></h3>
<p>BIND9 servers managed by Bindy:</p>
<ul>
<li>Deployed as Kubernetes StatefulSets</li>
<li>Configuration via ConfigMaps</li>
<li>Zone files mounted from ConfigMaps or PVCs</li>
<li>Support for primary and secondary architectures</li>
</ul>
<h2 id="data-flow"><a class="header" href="#data-flow">Data Flow</a></h2>
<h3 id="zone-creation-flow"><a class="header" href="#zone-creation-flow">Zone Creation Flow</a></h3>
<ol>
<li>
<p><strong>User creates DNSZone resource</strong></p>
<pre><code class="language-bash">kubectl apply -f dnszone.yaml
</code></pre>
</li>
<li>
<p><strong>Controller watches and receives event</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Watch stream receives create event
stream.next().await
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p><strong>DNSZone reconciler evaluates selector</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Find matching Bind9Instances
let instances = find_matching_instances(&amp;zone.spec.instance_selector).await?;
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p><strong>Generate zone file for each instance</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Create zone configuration
let zone_file = generate_zone_file(&amp;zone, &amp;records)?;
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p><strong>Update BIND9 configuration</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Apply ConfigMap with zone file
update_bind9_config(&amp;instance, &amp;zone_file).await?;
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p><strong>Update DNSZone status</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Report success
update_status(&amp;zone, conditions, matched_instances).await?;
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h3 id="record-addition-flow"><a class="header" href="#record-addition-flow">Record Addition Flow</a></h3>
<ol>
<li><strong>User creates DNS record resource</strong></li>
<li><strong>Controller receives event</strong></li>
<li><strong>Record reconciler validates zone reference</strong></li>
<li><strong>Append record to existing zone file</strong></li>
<li><strong>Reload BIND9 configuration</strong></li>
<li><strong>Update record status</strong></li>
</ol>
<h2 id="concurrency-model"><a class="header" href="#concurrency-model">Concurrency Model</a></h2>
<p>Bindy uses Rust's async/await with Tokio runtime:</p>
<pre><pre class="playground"><code class="language-rust">#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    // Spawn multiple reconcilers concurrently
    tokio::try_join!(
        run_bind9instance_controller(),
        run_dnszone_controller(),
        run_record_controllers(),
    )?;
    Ok(())
}</code></pre></pre>
<p>Benefits:</p>
<ul>
<li><strong>Concurrent reconciliation</strong> - Multiple resources reconciled simultaneously</li>
<li><strong>Non-blocking I/O</strong> - Efficient API server communication</li>
<li><strong>Low memory footprint</strong> - Async tasks use minimal memory</li>
<li><strong>High throughput</strong> - Handle thousands of DNS records efficiently</li>
</ul>
<h2 id="resource-watching"><a class="header" href="#resource-watching">Resource Watching</a></h2>
<p>The controller uses Kubernetes watch API with reflector caching:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let api: Api&lt;DNSZone&gt; = Api::all(client);
let watcher = watcher(api, ListParams::default());

// Reflector caches resources locally
let store = reflector::store::Writer::default();
let reader = store.as_reader();
let reflector = reflector(store, watcher);

// Process events
while let Some(event) = stream.try_next().await? {
    match event {
        Applied(zone) =&gt; reconcile_zone(zone).await?,
        Deleted(zone) =&gt; cleanup_zone(zone).await?,
        Restarted(_) =&gt; refresh_all().await?,
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h2>
<p>Multi-layer error handling strategy:</p>
<ol>
<li><strong>Validation Errors</strong> - Caught early, reported in status</li>
<li><strong>Reconciliation Errors</strong> - Retried with exponential backoff</li>
<li><strong>Fatal Errors</strong> - Logged and cause controller restart</li>
<li><strong>Status Reporting</strong> - All errors visible in resource status</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>match reconcile_zone(&amp;zone).await {
    Ok(_) =&gt; update_status(Ready, "Synchronized"),
    Err(e) =&gt; {
        log::error!("Failed to reconcile zone: {}", e);
        update_status(NotReady, e.to_string());
        // Requeue for retry
        Err(e)
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="performance-optimizations"><a class="header" href="#performance-optimizations">Performance Optimizations</a></h2>
<h3 id="1-incremental-updates"><a class="header" href="#1-incremental-updates">1. Incremental Updates</a></h3>
<p>Only regenerate zone files when records change, not on every reconciliation.</p>
<h3 id="2-caching"><a class="header" href="#2-caching">2. Caching</a></h3>
<p>Local cache of BIND9 instances to avoid repeated API calls.</p>
<h3 id="3-batch-processing"><a class="header" href="#3-batch-processing">3. Batch Processing</a></h3>
<p>Group related updates to minimize BIND9 reloads.</p>
<h3 id="4-zero-copy-operations"><a class="header" href="#4-zero-copy-operations">4. Zero-Copy Operations</a></h3>
<p>Use string slicing and references to avoid unnecessary allocations.</p>
<h3 id="5-compiled-binary"><a class="header" href="#5-compiled-binary">5. Compiled Binary</a></h3>
<p>Rust compilation produces optimized native code with no runtime overhead.</p>
<h2 id="security-architecture"><a class="header" href="#security-architecture">Security Architecture</a></h2>
<h3 id="rbac"><a class="header" href="#rbac">RBAC</a></h3>
<p>Controller uses least-privilege service account:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: bind9-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: bind9-controller
rules:
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["dnszones", "arecords", ...]
    verbs: ["get", "list", "watch", "update"]
</code></pre>
<h3 id="non-root-containers"><a class="header" href="#non-root-containers">Non-Root Containers</a></h3>
<p>Controller runs as non-root user:</p>
<pre><code class="language-dockerfile">USER 65532:65532
</code></pre>
<h3 id="network-policies"><a class="header" href="#network-policies">Network Policies</a></h3>
<p>Limit controller network access:</p>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: bind9-controller
spec:
  podSelector:
    matchLabels:
      app: bind9-controller
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443  # API server only
</code></pre>
<h2 id="scalability"><a class="header" href="#scalability">Scalability</a></h2>
<h3 id="horizontal-scaling"><a class="header" href="#horizontal-scaling">Horizontal Scaling</a></h3>
<p>Multiple controller replicas with leader election:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let lease_lock = LeaseLock::new(
    client,
    "dns-system",
    "bind9-controller-leader",
);

run_with_lease(lease_lock, reconcile_loop).await?;
<span class="boring">}</span></code></pre></pre>
<h3 id="resource-limits"><a class="header" href="#resource-limits">Resource Limits</a></h3>
<p>Recommended production configuration:</p>
<pre><code class="language-yaml">resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi
</code></pre>
<p>Can handle:</p>
<ul>
<li><strong>1000+</strong> DNS zones</li>
<li><strong>10,000+</strong> DNS records</li>
<li><strong>&lt;100ms</strong> average reconciliation time</li>
</ul>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li><a href="./crds.html">Custom Resource Definitions</a> - CRD specifications</li>
<li><a href="../development/controller-design.html">Controller Design</a> - Implementation details</li>
<li><a href="../advanced/performance.html">Performance Tuning</a> - Optimization strategies</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../concepts/concepts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../concepts/architecture-technical.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../concepts/concepts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../concepts/architecture-technical.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
