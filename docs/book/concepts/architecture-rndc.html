<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RNDC-Based Architecture</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rndc-based-architecture"><a class="header" href="#rndc-based-architecture">RNDC-Based Architecture</a></h1>
<p>This page provides a detailed overview of Bindy's new RNDC-based architecture that uses the native BIND9 Remote Name Daemon Control protocol for managing DNS zones and records.</p>
<h2 id="high-level-architecture"><a class="header" href="#high-level-architecture">High-Level Architecture</a></h2>
<pre><code>┌───────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes Cluster                                │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │               Custom Resource Definitions (CRDs)                    │ │
│  │                                                                     │ │
│  │  Bind9Cluster (cluster config) → Bind9Instance → DNSZone           │ │
│  │  DNSZone → ARecord, AAAARecord, TXTRecord, MXRecord, etc.          │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                  │                                        │
│                                  │ watches (Kubernetes API)               │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    Bindy Controller (Rust)                          │ │
│  │                                                                     │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │ │
│  │  │ Bind9Cluster │  │ Bind9Instance│  │      DNSZone             │ │ │
│  │  │  Reconciler  │  │  Reconciler  │  │     Reconciler           │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │ │
│  │                                                                     │ │
│  │  ┌──────────────────────────────────────────────────────────────┐  │ │
│  │  │         DNS Record Reconcilers (A, AAAA, TXT, etc.)          │  │ │
│  │  └──────────────────────────────────────────────────────────────┘  │ │
│  │                                                                     │ │
│  │  ┌──────────────────────────────────────────────────────────────┐  │ │
│  │  │              Bind9Manager (RNDC Client)                      │  │ │
│  │  │  • add_zone()     • reload_zone()    • notify_zone()        │  │ │
│  │  │  • delete_zone()  • freeze_zone()    • retransfer_zone()    │  │ │
│  │  │  • zone_status()  • thaw_zone()      • server_status()      │  │ │
│  │  └──────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                  │                                        │
│                                  │ RNDC Protocol (TSIG/HMAC-SHA256)       │
│                                  │ Port 953 / TCP                         │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    BIND9 Instances (Pods)                           │ │
│  │                                                                     │ │
│  │  ┌────────────────────┐        ┌────────────────────┐              │ │
│  │  │  Primary Instance  │  AXFR  │ Secondary Instance │              │ │
│  │  │  (bind9-primary)   │───────▶│  (bind9-secondary) │              │ │
│  │  │                    │  IXFR  │                    │              │ │
│  │  │  • rndc daemon     │◀───────│  • rndc daemon     │              │ │
│  │  │  • Port 953 (rndc) │        │  • Port 953 (rndc) │              │ │
│  │  │  • Port 53 (DNS)   │        │  • Port 53 (DNS)   │              │ │
│  │  │                    │        │                    │              │ │
│  │  │  Dynamic zones:    │        │  Transferred zones:│              │ │
│  │  │  - example.com     │        │  - example.com     │              │ │
│  │  │  - internal.local  │        │  - internal.local  │              │ │
│  │  └────────────────────┘        └────────────────────┘              │ │
│  │           │                              │                          │ │
│  │           └──────────────┬───────────────┘                          │ │
│  │                          │                                          │ │
│  └──────────────────────────┼──────────────────────────────────────────┘ │
│                             │                                            │
│  ┌──────────────────────────┼──────────────────────────────────────────┐ │
│  │        RNDC Keys (Kubernetes Secrets)                               │ │
│  │  • bind9-primary-rndc-key (HMAC-SHA256)                            │ │
│  │  • bind9-secondary-rndc-key (HMAC-SHA256)                          │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                             │                                            │
└─────────────────────────────┼────────────────────────────────────────────┘
                              │
                              │ DNS Queries (UDP/TCP 53)
                              ▼
                   ┌────────────────────┐
                   │   DNS Clients      │
                   │  • Applications    │
                   │  • Services        │
                   │  • External users  │
                   └────────────────────┘
</code></pre>
<h2 id="key-architectural-changes-from-file-based-approach"><a class="header" href="#key-architectural-changes-from-file-based-approach">Key Architectural Changes from File-Based Approach</a></h2>
<h3 id="old-architecture-file-based"><a class="header" href="#old-architecture-file-based">Old Architecture (File-Based)</a></h3>
<ul>
<li>Controller generated zone files</li>
<li>Files written to ConfigMaps</li>
<li>ConfigMaps mounted into BIND9 pods</li>
<li>Manual <code>rndc reload</code> triggered after file changes</li>
<li>Complex synchronization between ConfigMaps and BIND9 state</li>
</ul>
<h3 id="new-architecture-rndc-protocol--cluster-hierarchy"><a class="header" href="#new-architecture-rndc-protocol--cluster-hierarchy">New Architecture (RNDC Protocol + Cluster Hierarchy)</a></h3>
<ul>
<li><strong>Three-tier resource model</strong>: Bind9Cluster → Bind9Instance → DNSZone</li>
<li>Controller uses native RNDC protocol</li>
<li>Direct communication with BIND9 via port 953</li>
<li>Commands executed in real-time: <code>addzone</code>, <code>delzone</code>, <code>reload</code></li>
<li>No file manipulation or ConfigMap management</li>
<li>BIND9 manages zone files internally with dynamic updates</li>
<li>Atomic operations with immediate feedback</li>
<li>Cluster-level config sharing (version, TSIG keys, ACLs)</li>
</ul>
<h2 id="three-tier-resource-model"><a class="header" href="#three-tier-resource-model">Three-Tier Resource Model</a></h2>
<h3 id="1-bind9cluster-cluster-configuration"><a class="header" href="#1-bind9cluster-cluster-configuration">1. Bind9Cluster (Cluster Configuration)</a></h3>
<p>Defines shared configuration for a logical group of BIND9 instances:</p>
<pre><code class="language-yaml">apiVersion: bindy.firestoned.io/v1alpha1
kind: Bind9Cluster
metadata:
  name: production-dns
spec:
  version: "9.18"
  config:
    recursion: false
    dnssec:
      enabled: true
      validation: true
    allowQuery:
      - any
    allowTransfer:
      - 10.0.0.0/8
  tsigKeys:
    - name: transfer-key
      algorithm: hmac-sha256
      secret: base64-encoded-key
  acls:
    internal:
      - 10.0.0.0/8
      - 172.16.0.0/12
</code></pre>
<h3 id="2-bind9instance-instance-deployment"><a class="header" href="#2-bind9instance-instance-deployment">2. Bind9Instance (Instance Deployment)</a></h3>
<p>References a cluster and deploys BIND9 pods:</p>
<pre><code class="language-yaml">apiVersion: bindy.firestoned.io/v1alpha1
kind: Bind9Instance
metadata:
  name: dns-primary
spec:
  clusterRef: production-dns  # References Bind9Cluster
  role: primary
  replicas: 2
</code></pre>
<p>The instance inherits configuration from the cluster but can override specific settings.</p>
<h3 id="3-dnszone-zone-definition"><a class="header" href="#3-dnszone-zone-definition">3. DNSZone (Zone Definition)</a></h3>
<p>References an instance and creates zones via RNDC:</p>
<pre><code class="language-yaml">apiVersion: bindy.firestoned.io/v1alpha1
kind: DNSZone
metadata:
  name: example-com
spec:
  zoneName: example.com
  clusterRef: dns-primary  # References Bind9Instance
  soaRecord:
    primaryNS: ns1.example.com.
    adminEmail: admin.example.com.
    serial: 2024010101
</code></pre>
<h2 id="rndc-protocol-communication"><a class="header" href="#rndc-protocol-communication">RNDC Protocol Communication</a></h2>
<pre><code>┌──────────────────────┐                 ┌──────────────────────┐
│  Bindy Controller    │                 │   BIND9 Instance     │
│                      │                 │   (Primary)          │
│  ┌────────────────┐  │                 │                      │
│  │ Bind9Manager   │  │                 │  ┌────────────────┐  │
│  │                │  │   TCP Port 953  │  │  rndc daemon   │  │
│  │ RndcClient     │──┼────────────────▶│  │                │  │
│  │  • Server URL  │  │  TSIG Auth      │  │  Validates:    │  │
│  │  • Algorithm   │  │  HMAC-SHA256    │  │  • Key name    │  │
│  │  • Secret Key  │  │                 │  │  • Signature   │  │
│  │                │  │                 │  │  • Timestamp   │  │
│  └────────────────┘  │                 │  └────────────────┘  │
│         │            │                 │         │            │
│         │ Commands:  │                 │         │            │
│         │            │                 │         ▼            │
│    addzone zone {    │                 │  ┌────────────────┐  │
│      type master;    │                 │  │ BIND9 named    │  │
│      file "x.zone";  │────────────────▶│  │                │  │
│    };                │                 │  │ • Creates zone │  │
│                      │◀────────────────│  │ • Loads into   │  │
│    Success/Error     │    Response     │  │   memory       │  │
│                      │                 │  │ • Writes file  │  │
│                      │                 │  └────────────────┘  │
└──────────────────────┘                 └──────────────────────┘
</code></pre>
<h2 id="rndc-authentication-flow"><a class="header" href="#rndc-authentication-flow">RNDC Authentication Flow</a></h2>
<pre><code>┌────────────────────────────────────────────────────────────────┐
│  1. Controller Retrieves RNDC Key from Kubernetes Secret      │
│                                                                │
│  Secret: bind9-primary-rndc-key                              │
│    data:                                                      │
│      key-name: "bind9-primary"                               │
│      algorithm: "hmac-sha256"                                │
│      secret: "base64-encoded-256-bit-key"                    │
└────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────────────────┐
│  2. Create RndcClient Instance                                │
│                                                                │
│  let client = RndcClient::new(                                │
│      "bind9-primary.dns-system.svc.cluster.local:953",       │
│      "hmac-sha256",                                           │
│      "base64-secret-key"                                      │
│  );                                                           │
└────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────────────────┐
│  3. Execute RNDC Command with TSIG Authentication             │
│                                                                │
│  TSIG Signature = HMAC-SHA256(                                │
│      key: secret,                                             │
│      data: command + timestamp + nonce                        │
│  )                                                            │
│                                                                │
│  Request packet:                                              │
│    • Command: "addzone example.com { type master; ... }"     │
│    • TSIG record with signature                              │
│    • Timestamp                                                │
└────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────────────────┐
│  4. BIND9 Validates Request                                   │
│                                                                │
│  • Looks up key "bind9-primary" in rndc.key file             │
│  • Verifies HMAC-SHA256 signature matches                    │
│  • Checks timestamp is within acceptable window              │
│  • Executes command if valid                                 │
│  • Returns success/error with TSIG-signed response           │
└────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="data-flow-zone-creation"><a class="header" href="#data-flow-zone-creation">Data Flow: Zone Creation</a></h2>
<pre><code>User creates DNSZone resource
    │
    │ kubectl apply -f dnszone.yaml
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Kubernetes API Server stores DNSZone in etcd            │
└─────────────────────────────────────────────────────────┘
    │
    │ Watch event
    ▼
┌─────────────────────────────────────────────────────────┐
│ Bindy Controller receives event                         │
│   • DNSZone watcher triggers                            │
│   • Event: Applied(dnszone)                             │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ reconcile_dnszone() called                              │
│   1. Extract namespace and name                         │
│   2. Get zone spec (zone_name, cluster_ref, etc.)      │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Find PRIMARY pod for cluster                            │
│   • List pods with labels:                              │
│     app=bind9, instance={cluster_ref}                   │
│   • Select first running pod                            │
│   • Build server address:                               │
│     "{cluster_ref}.{namespace}.svc.cluster.local:953"   │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Load RNDC key from Secret                               │
│   • Secret name: "{cluster_ref}-rndc-key"              │
│   • Parse key-name, algorithm, secret                   │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Execute RNDC addzone command                            │
│   zone_manager.add_zone(                                │
│       zone_name: "example.com",                         │
│       zone_type: "master",                              │
│       zone_file: "/var/lib/bind/example.com.zone",     │
│       server: "bind9-primary...:953",                   │
│       key_data: RndcKeyData { ... }                     │
│   )                                                     │
└─────────────────────────────────────────────────────────┘
    │
    │ RNDC Protocol (Port 953)
    ▼
┌─────────────────────────────────────────────────────────┐
│ BIND9 Instance executes command                         │
│   • Creates zone configuration                          │
│   • Allocates memory for zone                           │
│   • Creates zone file /var/lib/bind/example.com.zone   │
│   • Loads zone into memory                              │
│   • Starts serving DNS queries for zone                 │
│   • Returns success response                            │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Update DNSZone status                                   │
│   status:                                               │
│     conditions:                                         │
│       - type: Ready                                     │
│         status: "True"                                  │
│         message: "Zone created for cluster: ..."        │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="data-flow-record-addition"><a class="header" href="#data-flow-record-addition">Data Flow: Record Addition</a></h2>
<pre><code>User creates ARecord resource
    │
    │ kubectl apply -f arecord.yaml
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Kubernetes API Server stores ARecord in etcd            │
└─────────────────────────────────────────────────────────┘
    │
    │ Watch event
    ▼
┌─────────────────────────────────────────────────────────┐
│ Bindy Controller receives event                         │
│   • ARecord watcher triggers                            │
│   • Event: Applied(arecord)                             │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ reconcile_a_record() called                             │
│   1. Extract namespace and name                         │
│   2. Get spec (zone, name, ipv4_address, ttl)          │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Find cluster from zone                                   │
│   • List DNSZone resources in namespace                 │
│   • Find zone matching spec.zone                        │
│   • Extract zone.spec.cluster_ref                       │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Load RNDC key and build server address                  │
│   • Load "{cluster_ref}-rndc-key" Secret               │
│   • Server: "{cluster_ref}.{namespace}.svc:953"        │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Add record via RNDC (PLACEHOLDER - Future nsupdate)     │
│   zone_manager.add_a_record(                            │
│       zone: "example.com",                              │
│       name: "www",                                      │
│       ipv4: "192.0.2.1",                               │
│       ttl: Some(300),                                   │
│       server: "bind9-primary...:953",                   │
│       key_data: RndcKeyData { ... }                     │
│   )                                                     │
│                                                         │
│ NOTE: Currently logs intent. Full implementation will   │
│       use nsupdate protocol for dynamic DNS updates.    │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Update ARecord status                                   │
│   status:                                               │
│     conditions:                                         │
│       - type: Ready                                     │
│         status: "True"                                  │
│         message: "A record created"                     │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="rndc-commands-supported"><a class="header" href="#rndc-commands-supported">RNDC Commands Supported</a></h2>
<p>The Bind9Manager provides the following RNDC operations:</p>
<h3 id="zone-management"><a class="header" href="#zone-management">Zone Management</a></h3>
<pre><code>┌────────────────────┬─────────────────────────────────────────┐
│ Operation          │ RNDC Command                            │
├────────────────────┼─────────────────────────────────────────┤
│ add_zone()         │ addzone &lt;zone&gt; { type &lt;type&gt;;           │
│                    │                   file "&lt;file&gt;"; };     │
│                    │                                         │
│ delete_zone()      │ delzone &lt;zone&gt;                          │
│                    │                                         │
│ reload_zone()      │ reload &lt;zone&gt;                           │
│                    │                                         │
│ reload_all_zones() │ reload                                  │
│                    │                                         │
│ retransfer_zone()  │ retransfer &lt;zone&gt;                       │
│                    │                                         │
│ notify_zone()      │ notify &lt;zone&gt;                           │
│                    │                                         │
│ freeze_zone()      │ freeze &lt;zone&gt;                           │
│                    │                                         │
│ thaw_zone()        │ thaw &lt;zone&gt;                             │
│                    │                                         │
│ zone_status()      │ zonestatus &lt;zone&gt;                       │
│                    │                                         │
│ server_status()    │ status                                  │
└────────────────────┴─────────────────────────────────────────┘
</code></pre>
<h3 id="record-management-planned"><a class="header" href="#record-management-planned">Record Management (Planned)</a></h3>
<pre><code>Currently implemented as placeholders:
  • add_a_record()      (will use nsupdate protocol)
  • add_aaaa_record()   (will use nsupdate protocol)
  • add_txt_record()    (will use nsupdate protocol)
  • add_cname_record()  (will use nsupdate protocol)
  • add_mx_record()     (will use nsupdate protocol)
  • add_ns_record()     (will use nsupdate protocol)
  • add_srv_record()    (will use nsupdate protocol)
  • add_caa_record()    (will use nsupdate protocol)

Note: RNDC protocol doesn't support individual record operations.
These will be implemented using the nsupdate protocol for dynamic
DNS updates, or via zone file manipulation + reload.
</code></pre>
<h2 id="pod-discovery-and-networking"><a class="header" href="#pod-discovery-and-networking">Pod Discovery and Networking</a></h2>
<pre><code>┌────────────────────────────────────────────────────────────┐
│ Controller discovers BIND9 pods using labels:              │
│                                                            │
│   Pod labels:                                             │
│     app: bind9                                            │
│     instance: {cluster_ref}                               │
│                                                            │
│   Controller searches:                                    │
│     List pods where app=bind9 AND instance={cluster_ref}  │
│                                                            │
│   Service DNS:                                            │
│     {cluster_ref}.{namespace}.svc.cluster.local:953      │
│                                                            │
│   Example:                                                │
│     bind9-primary.dns-system.svc.cluster.local:953       │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="zone-transfers-axfrixfr"><a class="header" href="#zone-transfers-axfrixfr">Zone Transfers (AXFR/IXFR)</a></h2>
<pre><code>Primary Instance                    Secondary Instance
┌─────────────────┐                ┌─────────────────┐
│ example.com     │                │                 │
│ Serial: 2024010│                │                 │
│                 │   1. NOTIFY    │                 │
│                 │───────────────▶│                 │
│                 │                │                 │
│                 │   2. SOA Query │                 │
│                 │◀───────────────│  Checks serial  │
│                 │                │                 │
│                 │   3. AXFR/IXFR │                 │
│                 │◀───────────────│  Serial outdated│
│                 │                │                 │
│  Sends full     │   Zone data    │                 │
│  zone (AXFR) or │───────────────▶│  Updates zone   │
│  delta (IXFR)   │                │  Serial: 2024010│
│                 │                │                 │
└─────────────────┘                └─────────────────┘

Triggered by:
  • zone_manager.notify_zone()
  • zone_manager.retransfer_zone()
  • BIND9 automatic refresh timers (SOA refresh value)
</code></pre>
<h2 id="components-deep-dive"><a class="header" href="#components-deep-dive">Components Deep Dive</a></h2>
<h3 id="1-bind9manager"><a class="header" href="#1-bind9manager">1. Bind9Manager</a></h3>
<p>Rust struct that wraps the <code>rndc</code> crate for BIND9 management:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Bind9Manager;

impl Bind9Manager {
    pub fn new() -&gt; Self { Self }

    // RNDC key generation
    pub fn generate_rndc_key() -&gt; RndcKeyData { ... }
    pub fn create_rndc_secret_data(key_data: &amp;RndcKeyData) -&gt; BTreeMap&lt;String, String&gt; { ... }
    pub fn parse_rndc_secret_data(data: &amp;BTreeMap&lt;String, Vec&lt;u8&gt;&gt;) -&gt; Result&lt;RndcKeyData&gt; { ... }

    // Core RNDC operations
    async fn exec_rndc_command(&amp;self, server: &amp;str, key_data: &amp;RndcKeyData, command: &amp;str) -&gt; Result&lt;String&gt; { ... }

    // Zone management
    pub async fn add_zone(&amp;self, zone_name: &amp;str, zone_type: &amp;str, zone_file: &amp;str, server: &amp;str, key_data: &amp;RndcKeyData) -&gt; Result&lt;()&gt; { ... }
    pub async fn delete_zone(&amp;self, zone_name: &amp;str, server: &amp;str, key_data: &amp;RndcKeyData) -&gt; Result&lt;()&gt; { ... }
    pub async fn reload_zone(&amp;self, zone_name: &amp;str, server: &amp;str, key_data: &amp;RndcKeyData) -&gt; Result&lt;()&gt; { ... }
    pub async fn notify_zone(&amp;self, zone_name: &amp;str, server: &amp;str, key_data: &amp;RndcKeyData) -&gt; Result&lt;()&gt; { ... }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="2-rndckeydata"><a class="header" href="#2-rndckeydata">2. RndcKeyData</a></h3>
<p>Struct for RNDC authentication:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct RndcKeyData {
    pub name: String,      // Key name (e.g., "bind9-primary")
    pub algorithm: String, // HMAC algorithm (e.g., "hmac-sha256")
    pub secret: String,    // Base64-encoded secret key
}
<span class="boring">}</span></code></pre></pre>
<h3 id="3-reconcilers"><a class="header" href="#3-reconcilers">3. Reconcilers</a></h3>
<p>Zone reconciler using RNDC:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn reconcile_dnszone(
    client: Client,
    dnszone: DNSZone,
    zone_manager: &amp;Bind9Manager,
) -&gt; Result&lt;()&gt; {
    // 1. Find PRIMARY pod
    let primary_pod = find_primary_pod(&amp;client, &amp;namespace, &amp;cluster_ref).await?;

    // 2. Load RNDC key
    let key_data = load_rndc_key(&amp;client, &amp;namespace, &amp;cluster_ref).await?;

    // 3. Build server address
    let server = format!("{}.{}.svc.cluster.local:953", cluster_ref, namespace);

    // 4. Add zone via RNDC
    zone_manager.add_zone(&amp;zone_name, "master", &amp;zone_file, &amp;server, &amp;key_data).await?;

    // 5. Update status
    update_status(&amp;client, &amp;dnszone, "Ready", "True", "Zone created").await?;

    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<h2 id="security-architecture"><a class="header" href="#security-architecture">Security Architecture</a></h2>
<h3 id="tsig-authentication"><a class="header" href="#tsig-authentication">TSIG Authentication</a></h3>
<pre><code>┌────────────────────────────────────────────────────────────┐
│ TSIG (Transaction Signature) provides:                     │
│                                                            │
│  1. Authentication - Verifies command source               │
│  2. Integrity - Prevents command tampering                 │
│  3. Replay protection - Timestamp validation               │
│                                                            │
│ Algorithm: HMAC-SHA256 (256-bit keys)                     │
│ Key Storage: Kubernetes Secrets (base64-encoded)          │
│ Key Generation: Random 256-bit keys per instance          │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="network-security"><a class="header" href="#network-security">Network Security</a></h3>
<pre><code>┌────────────────────────────────────────────────────────────┐
│ • RNDC traffic on port 953/TCP (not exposed externally)   │
│ • DNS queries on port 53/UDP+TCP (exposed via Service)    │
│ • All RNDC communication within cluster network           │
│ • No external RNDC access (ClusterIP services only)       │
│ • NetworkPolicies can restrict RNDC access to controller  │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="rbac-requirements"><a class="header" href="#rbac-requirements">RBAC Requirements</a></h3>
<pre><code class="language-yaml"># Controller needs access to:
- Secrets (get, list) - for RNDC keys
- Pods (get, list) - for pod discovery
- Services (get, list) - for DNS resolution
- DNSZone, ARecord, etc. (get, list, watch, update status)
</code></pre>
<h2 id="performance-characteristics"><a class="header" href="#performance-characteristics">Performance Characteristics</a></h2>
<h3 id="latency"><a class="header" href="#latency">Latency</a></h3>
<pre><code>Operation                    Old (File-based)    New (RNDC)
─────────────────────────────────────────────────────────────
Create DNSZone              2-5 seconds          &lt;500ms
Add DNS Record              1-3 seconds          &lt;200ms
Delete DNSZone              2-4 seconds          &lt;500ms
Zone reload                 1-2 seconds          &lt;300ms
Status check                N/A                  &lt;100ms
</code></pre>
<h3 id="benefits-of-rndc-protocol"><a class="header" href="#benefits-of-rndc-protocol">Benefits of RNDC Protocol</a></h3>
<pre><code>✓ Atomic operations - Commands succeed or fail atomically
✓ Real-time feedback - Immediate success/error responses
✓ No ConfigMap overhead - No intermediate Kubernetes resources
✓ Direct control - Native BIND9 management interface
✓ Better error messages - BIND9 provides detailed errors
✓ Zone status queries - Can check zone state anytime
✓ Freeze/thaw support - Control dynamic updates precisely
✓ Notify support - Trigger zone transfers on demand
</code></pre>
<h2 id="future-enhancements"><a class="header" href="#future-enhancements">Future Enhancements</a></h2>
<h3 id="1-nsupdate-protocol-integration"><a class="header" href="#1-nsupdate-protocol-integration">1. nsupdate Protocol Integration</a></h3>
<pre><code>Implement dynamic DNS updates for individual records:
  • Use nsupdate protocol alongside RNDC
  • Add/update/delete individual A, AAAA, TXT, etc. records
  • No full zone reload needed for record changes
  • Even lower latency for record operations
</code></pre>
<h3 id="2-zone-transfer-monitoring"><a class="header" href="#2-zone-transfer-monitoring">2. Zone Transfer Monitoring</a></h3>
<pre><code>Monitor AXFR/IXFR operations:
  • Track transfer status
  • Report transfer errors
  • Automatic retry on failures
</code></pre>
<h3 id="3-health-checks"><a class="header" href="#3-health-checks">3. Health Checks</a></h3>
<pre><code>Periodic health checks using RNDC:
  • server_status() - overall server health
  • zone_status() - per-zone health
  • Update CRD status with health information
</code></pre>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li><a href="../development/bind9-integration.html">BIND9 Integration Deep Dive</a> - Implementation details</li>
<li><a href="../reference/dnszone-spec.html">DNSZone Spec</a> - DNSZone resource reference</li>
<li><a href="../operations/configuration.html">Operations Guide</a> - Production configuration</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../concepts/architecture-technical.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../concepts/crds.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../concepts/architecture-technical.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../concepts/crds.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
