apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: bindy-role
  labels:
    app.kubernetes.io/name: bindy
    app.kubernetes.io/component: rbac
rules:
  # Bind9Instance resources
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9instances"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read instances for status updates
    # - "create": Create instances for Bind9Cluster scaling
    # - "update", "patch": Update instance configuration
    # - "delete": Scale down instances (Bind9Cluster reconciler) and finalizer cleanup

  # Bind9Instance status subresource (separate permissions for least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9instances/status"]
    verbs: ["get", "update", "patch"]
    # Status updates only need get/update/patch, not create/delete

  # Bind9Cluster resources
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9clusters"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read clusters for status updates
    # - "create": Create clusters for ClusterBind9Provider
    # - "update", "patch": Update cluster configuration
    # - "delete": Clean up clusters (ClusterBind9Provider finalizer cleanup)

  # Bind9Cluster status subresource (separate permissions for least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["bind9clusters/status"]
    verbs: ["get", "update", "patch"]
    # Status updates only need get/update/patch, not create/delete

  # ClusterBind9Provider resources - cluster-scoped, NO DELETE (least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["clusterbind9providers"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    # Removed: "delete" - Use bindy-admin-role for deletions

  # ClusterBind9Provider status subresource (separate permissions for least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["clusterbind9providers/status"]
    verbs: ["get", "update", "patch"]
    # Status updates only need get/update/patch, not create/delete

  # DNSZone resources - NO DELETE (least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["dnszones"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    # Removed: "delete" - Use bindy-admin-role for deletions

  # DNSZone status subresource (separate permissions for least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources: ["dnszones/status"]
    verbs: ["get", "update", "patch"]
    # Status updates only need get/update/patch, not create/delete

  # Record resources - NO DELETE (least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources:
      - "arecords"
      - "aaaarecords"
      - "txtrecords"
      - "cnamerecords"
      - "mxrecords"
      - "nsrecords"
      - "srvrecords"
      - "caarecords"
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    # Removed: "delete" - Use bindy-admin-role for deletions

  # Record status subresources (separate permissions for least privilege)
  - apiGroups: ["bindy.firestoned.io"]
    resources:
      - "arecords/status"
      - "aaaarecords/status"
      - "txtrecords/status"
      - "cnamerecords/status"
      - "mxrecords/status"
      - "nsrecords/status"
      - "srvrecords/status"
      - "caarecords/status"
    verbs: ["get", "update", "patch"]
    # Status updates only need get/update/patch, not create/delete

  # Kubernetes Deployments
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read deployment status
    # - "create": Create deployments for Bind9Instance
    # - "update", "patch": Update deployment configuration
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes Services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read service status and endpoints
    # - "create": Create services for Bind9Instance
    # - "update", "patch": Update service configuration (preserves clusterIP)
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read configuration data
    # - "create": Create ConfigMaps for Bind9Instance configuration
    # - "update", "patch": Update BIND9 configuration (zone changes)
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes Secrets - RNDC key management (CRITICAL: least privilege for sensitive data)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "patch", "delete"]
    # Permissions needed:
    # - "get": Load RNDC keys for zone updates (DNSZone reconciler)
    # - "list": Check if RNDC secrets exist (Bind9Cluster reconciler)
    # - "watch": Monitor RNDC secret changes
    # - "create": Generate RNDC keys for new Bind9Instance resources
    # - "patch": Add rotation annotations to existing Secrets without regenerating keys
    #            (RNDC key rotation feature - adds metadata only, preserves key data)
    # - "delete": Clean up RNDC keys when Bind9Instance is deleted (finalizer)
    # Removed: "update" - Full updates not needed, patch is sufficient for annotation changes
    # PCI-DSS 7.1.2: Minimal permissions for RNDC secret lifecycle management

  # Kubernetes ServiceAccounts
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    # Permissions needed:
    # - "get", "list", "watch": Read service account status
    # - "create": Create service accounts for Bind9Instance pods
    # - "update", "patch": Update service account configuration
    # - "delete": Finalizer cleanup (Bind9Instance reconciler)
    # Note: Owner references provide automatic GC, but finalizer explicitly deletes

  # Kubernetes Pods - READ-ONLY (for discovery and status)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Kubernetes Endpoints - READ-ONLY (for service discovery)
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch"]

  # Events for logging (no delete needed)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # Leases for leader election (no delete needed for HA)
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "create", "update", "patch"]
