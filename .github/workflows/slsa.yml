# Copyright (c) 2025 Erick Bourgeois, firestoned
# SPDX-License-Identifier: MIT

name: SLSA Provenance

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  # Extract version from release tag or Cargo.toml
  extract-version:
    name: Extract Version from Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version-release.outputs.version || steps.version-cargo.outputs.version }}
      tag_name: ${{ steps.version-release.outputs.tag-name || steps.version-cargo.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from release tag
        if: github.event_name == 'release'
        id: version-release
        uses: ./.github/actions/extract-version
        with:
          workflow-type: release
          release-tag: ${{ github.event.release.tag_name }}

      - name: Get version from Cargo.toml (workflow_dispatch fallback)
        if: github.event_name == 'workflow_dispatch'
        id: version-cargo
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using Cargo.toml version: $VERSION"

  # Build binaries with SLSA provenance
  build:
    name: Build with provenance
    runs-on: ubuntu-latest
    needs: extract-version
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
      version: ${{ needs.extract-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Cargo.toml version
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.extract-version.outputs.version }}"/' Cargo.toml
          echo "Updated Cargo.toml to version ${{ needs.extract-version.outputs.version }}"
          grep '^version = ' Cargo.toml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: |
          cargo build --release --locked
          cp target/release/bindy bindy-${{ needs.extract-version.outputs.version }}-x86_64-linux

      - name: Generate binary hashes
        id: hash
        run: |
          # Generate SHA256 hashes for provenance
          sha256sum bindy-${{ needs.extract-version.outputs.version }}-x86_64-linux > checksums.txt
          cat checksums.txt
          echo "hashes=$(cat checksums.txt | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindy-binary
          path: |
            bindy-${{ needs.extract-version.outputs.version }}-x86_64-linux
            checksums.txt
          retention-days: 90

  # Generate SLSA provenance
  provenance:
    name: Generate SLSA provenance
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: true

  # Verify provenance (testing)
  verify:
    name: Verify SLSA provenance
    runs-on: ubuntu-latest
    needs: [build, provenance]

    steps:
      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: bindy-binary

      - name: Download provenance
        uses: actions/download-artifact@v4
        with:
          name: "${{ needs.build.outputs.version }}.intoto.jsonl"

      - name: Install SLSA verifier
        run: |
          curl -sSfL https://github.com/slsa-framework/slsa-verifier/releases/download/v2.4.1/slsa-verifier-linux-amd64 -o slsa-verifier
          chmod +x slsa-verifier

      - name: Verify SLSA provenance
        run: |
          # Verify the provenance matches the binary
          ./slsa-verifier verify-artifact \
            --provenance-path "${{ needs.build.outputs.version }}.intoto.jsonl" \
            --source-uri github.com/${{ github.repository }} \
            bindy-${{ needs.build.outputs.version }}-x86_64-linux

          echo "âœ… SLSA provenance verification succeeded!"

  # Upload to release (if triggered by release)
  release:
    name: Upload to release
    runs-on: ubuntu-latest
    needs: [build, provenance, verify]
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: bindy-binary

      - name: Download provenance
        uses: actions/download-artifact@v4
        with:
          name: "${{ needs.build.outputs.version }}.intoto.jsonl"

      - name: Upload binary to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            bindy-${{ needs.build.outputs.version }}-x86_64-linux
            checksums.txt
            ${{ needs.build.outputs.version }}.intoto.jsonl
