---
name: "[CRITICAL] Add Vulnerability Scanning to CI/CD"
about: Implement automated vulnerability scanning for dependencies and container images
title: "[C-3] Add Vulnerability Scanning to CI/CD"
labels: ["compliance", "security", "critical", "pci-dss", "sox", "basel-iii"]
assignees: []
---

# [C-3] Add Vulnerability Scanning to CI/CD

**Compliance Framework:** PCI-DSS 6.2, SOX IT Controls, Basel III Cyber Risk
**Severity:** ðŸ”´ **CRITICAL** - Deployment Blocker
**Effort Estimate:** 2-3 weeks
**Status:** ðŸ“‹ Not Started

---

## Problem Statement

The project currently has **NO automated vulnerability scanning** for:
- Rust dependencies (`Cargo.lock`)
- Container images (base images + built artifacts)
- Development dependencies
- Transitive dependencies

This creates the following compliance violations:

### PCI-DSS 6.2 Violation
**Requirement 6.2:** Protect all system components from known vulnerabilities by installing applicable security patches/updates.

**Current Gap:**
- No automated scanning to identify known vulnerabilities
- No process to track and remediate CVEs
- No SLA for patching CRITICAL/HIGH vulnerabilities

### SOX 404 IT General Controls Violation
**Requirement:** IT systems must have controls to identify and remediate security vulnerabilities.

**Current Gap:**
- No documented vulnerability management process
- No audit trail of vulnerability remediation
- No scheduled security scans

### Basel III Operational/Cyber Risk
**Framework:** Banks must manage cyber risk through preventive controls.

**Current Gap:**
- No visibility into supply chain vulnerabilities
- No process to prevent deployment of vulnerable code
- No metrics on vulnerability exposure time

---

## Impact Assessment

### Security Impact
- **Supply Chain Attacks:** Vulnerable dependencies could be exploited
- **Container Vulnerabilities:** Base images may contain exploitable CVEs
- **Zero-Day Exposure:** No mechanism to detect newly disclosed vulnerabilities
- **Compliance Failures:** PCI-DSS audit failures, SOX control deficiencies

### Business Impact
- **Audit Findings:** CRITICAL findings in PCI-DSS/SOX audits
- **Production Incidents:** Exploitable vulnerabilities in production
- **Regulatory Fines:** Potential fines for compliance violations
- **Reputation Damage:** Security incidents from known vulnerabilities

### Operational Impact
- **Manual Scanning:** Engineers must manually check dependencies
- **Delayed Deployments:** No automated gate for vulnerable code
- **Incident Response:** Reactive vulnerability management

---

## Requirements

### 1. Rust Dependency Scanning

**Tool:** `cargo audit`
**Integration Points:**
- All GitHub Actions workflows (PR, main, release)
- Pre-commit hooks (optional)
- Scheduled daily scans

**Requirements:**
- Scan `Cargo.lock` for known vulnerabilities (RUSTSEC database)
- Fail CI/CD on CRITICAL/HIGH vulnerabilities
- Generate SARIF reports for GitHub Security tab
- Check both direct and transitive dependencies

**Success Criteria:**
```bash
cargo audit --deny warnings
# Exit code 1 if any vulnerabilities found
```

### 2. Container Image Scanning

**Tool:** Trivy (Aqua Security)
**Integration Points:**
- Docker build workflows
- Release workflows
- Scheduled daily scans of published images

**Requirements:**
- Scan base images (Debian, Alpine, etc.)
- Scan built container images before push
- Fail on CRITICAL/HIGH vulnerabilities
- Generate SBOM (Software Bill of Materials)
- Upload scan results to GitHub Security

**Success Criteria:**
```bash
trivy image --severity CRITICAL,HIGH --exit-code 1 ghcr.io/firestoned/bindy:latest
# Exit code 1 if CRITICAL/HIGH vulnerabilities found
```

### 3. Scheduled Security Scans

**Workflow:** `.github/workflows/security-scan.yaml`
**Schedule:** Daily at 00:00 UTC (cron: `0 0 * * *`)

**Requirements:**
- Scan all dependencies with `cargo audit`
- Scan all published container images with Trivy
- Create GitHub issues for new vulnerabilities
- Send Slack/email notifications for CRITICAL findings
- Track vulnerability age and remediation SLA

**Success Criteria:**
- Workflow runs daily without manual intervention
- New vulnerabilities create GitHub issues automatically
- Audit trail of all scans in GitHub Actions logs

### 4. Vulnerability Management Policy

**Document:** `docs/security/VULNERABILITY_MANAGEMENT.md`

**Requirements:**
- Define vulnerability severity levels (CRITICAL, HIGH, MEDIUM, LOW)
- Define remediation SLAs:
  - CRITICAL: 24 hours
  - HIGH: 7 days
  - MEDIUM: 30 days
  - LOW: 90 days or next release
- Define process for tracking vulnerabilities
- Define escalation procedures for missed SLAs
- Define exception process (risk acceptance)

**Success Criteria:**
- Policy reviewed and approved by security team
- SLAs documented and enforced
- Audit trail of vulnerability remediation

### 5. Remediate Existing Vulnerabilities

**Requirement:** Before enforcing CI/CD gates, remediate all existing CRITICAL/HIGH vulnerabilities.

**Process:**
1. Run `cargo audit` and Trivy scans
2. Catalog all findings with CVE IDs
3. Prioritize by severity and exploitability
4. Update dependencies to patched versions
5. If no patch available, document risk acceptance or implement workaround

**Success Criteria:**
- Zero CRITICAL vulnerabilities in dependencies
- Zero HIGH vulnerabilities in container base images
- All findings documented with remediation plan

---

## Implementation Plan

### Phase 1: Setup and Tooling (Week 1)

**Tasks:**
- [ ] Install `cargo-audit` in CI/CD workflows
- [ ] Install Trivy scanner in CI/CD workflows
- [ ] Create `.github/workflows/security-scan.yaml` for scheduled scans
- [ ] Configure SARIF output for GitHub Security tab
- [ ] Test scanning locally and in CI

**Deliverables:**
- `cargo audit` runs in all workflows
- Trivy scans container images
- Scheduled daily scans configured

### Phase 2: Policy and Process (Week 2)

**Tasks:**
- [ ] Write `docs/security/VULNERABILITY_MANAGEMENT.md` policy
- [ ] Define vulnerability severity levels and SLAs
- [ ] Configure automated issue creation for new vulnerabilities
- [ ] Set up notifications (Slack/email) for CRITICAL findings
- [ ] Document exception/risk acceptance process

**Deliverables:**
- Vulnerability management policy approved
- Automated issue creation configured
- Notification channels configured

### Phase 3: Remediation and Enforcement (Week 3)

**Tasks:**
- [ ] Run full vulnerability scan (cargo audit + Trivy)
- [ ] Remediate all CRITICAL vulnerabilities
- [ ] Remediate all HIGH vulnerabilities
- [ ] Document any accepted risks
- [ ] Enable CI/CD failure on CRITICAL/HIGH findings
- [ ] Update `CHANGELOG.md` and `SECURITY.md`

**Deliverables:**
- Zero CRITICAL/HIGH vulnerabilities
- CI/CD enforces vulnerability gates
- Documentation updated

---

## Technical Design

### Cargo Audit Integration

Add to all workflows (`.github/workflows/pr.yaml`, `main.yaml`, `release.yaml`):

```yaml
jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-audit
        id: cache-cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit-0.20.0

      - name: Install cargo-audit
        if: steps.cache-cargo-audit.outputs.cache-hit != 'true'
        run: cargo install cargo-audit --version 0.20.0

      - name: Run cargo audit
        run: cargo audit --deny warnings --json | tee audit-report.json

      - name: Upload audit report to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: audit-report.sarif
          category: cargo-audit
```

### Trivy Container Scanning

Add to Docker build workflows:

```yaml
jobs:
  docker-security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on CRITICAL/HIGH

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy
```

### Scheduled Security Scan Workflow

Create `.github/workflows/security-scan.yaml`:

```yaml
name: Scheduled Security Scan

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  cargo-audit:
    name: Scan Rust Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust and cargo-audit
        run: |
          rustup update stable
          cargo install cargo-audit

      - name: Run cargo audit
        id: audit
        continue-on-error: true
        run: |
          cargo audit --json > audit-report.json
          cargo audit --deny warnings

      - name: Create issue if vulnerabilities found
        if: steps.audit.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
            const vulns = report.vulnerabilities.list;

            const body = `## ðŸš¨ Security Vulnerabilities Detected

            **Found ${vulns.length} vulnerabilities in Rust dependencies**

            ${vulns.map(v => `- **${v.advisory.id}**: ${v.package.name}@${v.package.version} - ${v.advisory.title}`).join('\n')}

            **Action Required:** Review and remediate within SLA.
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY] Vulnerabilities detected in dependencies`,
              body: body,
              labels: ['security', 'vulnerability', 'automated']
            });

  trivy-scan:
    name: Scan Container Images
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:latest
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Create issue if vulnerabilities found
        # Similar to cargo-audit issue creation
```

---

## Success Criteria

### CI/CD Integration
- âœ… `cargo audit` runs in all workflows (PR, main, release)
- âœ… Trivy scans all container images before push
- âœ… CI fails on CRITICAL/HIGH vulnerabilities
- âœ… SARIF reports uploaded to GitHub Security tab

### Scheduled Scans
- âœ… Daily scans run at 00:00 UTC
- âœ… GitHub issues created for new vulnerabilities
- âœ… Notifications sent for CRITICAL findings

### Vulnerability Management
- âœ… Policy documented with SLAs
- âœ… All existing CRITICAL/HIGH vulnerabilities remediated
- âœ… Audit trail in GitHub Actions and issues

### Compliance
- âœ… PCI-DSS 6.2: Automated vulnerability identification âœ…
- âœ… SOX 404: IT controls for security patching âœ…
- âœ… Basel III: Cyber risk preventive controls âœ…

---

## Testing and Verification

### Test Cargo Audit Integration
```bash
# Locally test cargo audit
cargo audit --deny warnings

# Should exit 0 if no vulnerabilities
echo $?
```

### Test Trivy Scanning
```bash
# Locally test Trivy
docker pull ghcr.io/firestoned/bindy:latest
trivy image --severity CRITICAL,HIGH --exit-code 1 ghcr.io/firestoned/bindy:latest

# Should exit 0 if no CRITICAL/HIGH vulnerabilities
echo $?
```

### Test Scheduled Workflow
```bash
# Manually trigger workflow
gh workflow run security-scan.yaml

# Check workflow logs
gh run list --workflow=security-scan.yaml
```

---

## Rollout Plan

### Option A: Immediate Enforcement (Recommended)
1. Remediate all existing vulnerabilities
2. Enable CI/CD failure gates immediately
3. All new PRs must pass vulnerability scans

**Pros:**
- Immediate compliance
- Forces security-first development
- Clear gate for vulnerable code

**Cons:**
- May block PRs initially
- Requires upfront remediation effort

### Option B: Phased Rollout
1. Week 1: Add scanning (warnings only)
2. Week 2: Remediate existing vulnerabilities
3. Week 3: Enable CI/CD failure gates

**Pros:**
- Gradual adoption
- Time to remediate existing issues

**Cons:**
- Vulnerable code could merge during rollout
- Delayed compliance

---

## Documentation Updates

**Files to Update:**
- `SECURITY.md` - Add vulnerability disclosure and scanning policy
- `CONTRIBUTING.md` - Add note about vulnerability scanning requirements
- `docs/security/VULNERABILITY_MANAGEMENT.md` - New policy document
- `CHANGELOG.md` - Document vulnerability scanning implementation
- `README.md` - Add security scanning badges

**Example Badge for README:**
```markdown
[![Security Scan](https://github.com/firestoned/bindy/actions/workflows/security-scan.yaml/badge.svg)](https://github.com/firestoned/bindy/actions/workflows/security-scan.yaml)
```

---

## References

- [cargo-audit Documentation](https://github.com/rustsec/rustsec/tree/main/cargo-audit)
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [RustSec Advisory Database](https://rustsec.org/)
- [PCI-DSS Requirement 6.2](https://www.pcisecuritystandards.org/)
- [GitHub Code Scanning](https://docs.github.com/en/code-security/code-scanning)

---

**Assigned To:** Security Team
**Target Completion:** End of Week 4 (Phase 1 Critical Fixes)
**Blocked By:** None
**Blocks:** Production deployment
