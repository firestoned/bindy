---
name: "[CRITICAL] Add Vulnerability Scanning to CI/CD"
about: Security - implement automated vulnerability scanning for dependencies and container images
title: '[Compliance C-3] Implement Vulnerability Scanning in CI/CD Pipeline'
labels: compliance, critical, security, ci-cd, supply-chain
assignees: ''
---

## Severity: CRITICAL

**Compliance Frameworks:** PCI-DSS 6.2, SOX IT Controls, Basel III Cyber Risk

## Summary

CI/CD pipelines do not include vulnerability scanning for Rust dependencies or container images. This violates PCI-DSS vulnerability management requirements and exposes the project to known CVEs.

## Problem

**Location:** `.github/workflows/main.yaml`, `.github/workflows/release.yaml`

**Current State:**
- ❌ No dependency vulnerability scanning (cargo audit)
- ❌ No container image scanning (Trivy, Grype, etc.)
- ❌ No CVE detection before deployment
- ❌ No automated alerts for new vulnerabilities

**Risk:**
- Known CVEs deployed to production undetected
- Supply chain attacks not caught early
- Compliance violations (PCI-DSS 6.2)
- No visibility into dependency security posture

**Impact:**
- ❌ **PCI-DSS 6.2:** Requires vulnerability management program with scanning
- ❌ **SOX IT Controls:** Deficient controls for production deployments
- ❌ **Basel III:** Cyber risk and operational risk exposure
- ❌ **Incident Response:** No early detection of supply chain compromise

## Solution

### Phase 1: Add Dependency Scanning (Week 1)

1. **Add `cargo audit` to all workflows:**

```yaml
# .github/workflows/main.yaml
# .github/workflows/pr.yaml
# .github/workflows/release.yaml

jobs:
  security-audit:
    name: Security Audit - Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo audit binary
        id: cache-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit-0.20.1
          restore-keys: |
            ${{ runner.os }}-cargo-audit-

      - name: Install cargo-audit
        if: steps.cache-audit.outputs.cache-hit != 'true'
        run: cargo install cargo-audit --version 0.20.1

      - name: Run cargo audit
        run: |
          cargo audit --deny warnings --deny yanked
        # Fail build on HIGH/CRITICAL vulnerabilities

      - name: Generate audit report (JSON)
        if: always()
        run: |
          cargo audit --json > audit-report.json || true

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 90  # Keep for compliance
```

2. **Configure cargo audit settings:**

Create `.cargo/audit.toml`:
```toml
# .cargo/audit.toml

[database]
# Fetch latest advisory database
fetch = true
# Update database before each audit
update = true

[advisories]
# Ignore specific advisories (with justification)
# Example:
# ignore = [
#   "RUSTSEC-2023-0001",  # Justification: Not applicable to our use case
# ]

# Severity levels to fail on
severity-threshold = "medium"  # Fail on medium, high, critical

[yanked]
# Fail if using yanked crates (potentially compromised)
enabled = true
update-index = true
```

### Phase 2: Add Container Image Scanning (Week 1-2)

3. **Add Trivy scanning for container images:**

```yaml
# .github/workflows/main.yaml (after docker build)
# .github/workflows/release.yaml (after docker build)

jobs:
  docker:
    name: Build and Scan Docker Image
    # ... existing build steps ...

    - name: Build and push Docker image
      id: docker_build
      uses: docker/build-push-action@v5
      with:
        # ... existing config ...
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/${{ github.repository }}:${{ steps.tag.outputs.tag }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: 1  # Fail build on CRITICAL/HIGH vulnerabilities

    - name: Run Trivy vulnerability scanner (JSON report)
      if: always()
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/${{ github.repository }}:${{ steps.tag.outputs.tag }}
        format: 'json'
        output: 'trivy-results.json'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Upload Trivy JSON report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-scan-report
        path: trivy-results.json
        retention-days: 90  # Keep for compliance
```

### Phase 3: Add Continuous Monitoring (Week 2)

4. **Add scheduled vulnerability scanning:**

Create new workflow `.github/workflows/security-scan.yaml`:

```yaml
name: Security Scan - Scheduled

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  dependency-audit:
    name: Daily Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --version 0.20.1

      - name: Run cargo audit
        id: audit
        run: |
          cargo audit --json > audit-report.json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      - name: Parse audit results
        if: always()
        run: |
          if [ -f audit-report.json ]; then
            # Count vulnerabilities by severity
            CRITICAL=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "critical")] | length' audit-report.json)
            HIGH=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "high")] | length' audit-report.json)
            MEDIUM=$(jq '[.vulnerabilities.list[] | select(.advisory.severity == "medium")] | length' audit-report.json)

            echo "Vulnerabilities found:"
            echo "  CRITICAL: $CRITICAL"
            echo "  HIGH: $HIGH"
            echo "  MEDIUM: $MEDIUM"

            echo "critical=$CRITICAL" >> $GITHUB_ENV
            echo "high=$HIGH" >> $GITHUB_ENV
            echo "medium=$MEDIUM" >> $GITHUB_ENV
          fi

      - name: Create GitHub Issue for new vulnerabilities
        if: steps.audit.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));

            const vulnerabilities = audit.vulnerabilities.list || [];
            if (vulnerabilities.length === 0) return;

            // Group by severity
            const bySeverity = vulnerabilities.reduce((acc, v) => {
              const severity = v.advisory.severity || 'unknown';
              acc[severity] = acc[severity] || [];
              acc[severity].push(v);
              return acc;
            }, {});

            // Build issue body
            let body = '## Security Vulnerabilities Detected\\n\\n';
            body += `**Scan Date:** ${new Date().toISOString()}\\n\\n`;

            for (const [severity, vulns] of Object.entries(bySeverity)) {
              body += `### ${severity.toUpperCase()} Severity (${vulns.length})\\n\\n`;
              for (const v of vulns) {
                body += `- **${v.advisory.id}**: ${v.advisory.title}\\n`;
                body += `  - Package: \`${v.package.name}\` ${v.package.version}\\n`;
                body += `  - Patched: ${v.advisory.patched_versions.join(', ') || 'None'}\\n`;
                body += `  - URL: ${v.advisory.url}\\n\\n`;
              }
            }

            body += '\\n---\\n';
            body += '**Action Required:** Review and remediate vulnerabilities according to severity.\\n';
            body += '**Remediation SLA:**\\n';
            body += '- CRITICAL: 24 hours\\n';
            body += '- HIGH: 7 days\\n';
            body += '- MEDIUM: 30 days\\n';

            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY] ${vulnerabilities.length} Vulnerabilities Detected`,
              body: body,
              labels: ['security', 'vulnerability', 'automated']
            });

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-audit-report-${{ github.run_number }}
          path: audit-report.json
          retention-days: 90

  container-scan:
    name: Daily Container Image Scan
    runs-on: ubuntu-latest
    steps:
      - name: Scan latest production image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/${{ github.repository }}:latest'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-container-scan-${{ github.run_number }}
          path: trivy-results.json
          retention-days: 90
```

### Phase 4: Define Remediation SLAs (Week 2)

5. **Document vulnerability remediation policy:**

Create `docs/security/VULNERABILITY_MANAGEMENT.md`:

```markdown
# Vulnerability Management Policy

## Scanning Schedule

- **CI/CD Builds:** Every build
- **Scheduled Scans:** Daily at 2 AM UTC
- **Ad-hoc Scans:** As needed via manual workflow dispatch

## Remediation SLAs

| Severity | Response Time | Remediation SLA | Escalation |
|----------|---------------|-----------------|------------|
| CRITICAL | 1 hour | 24 hours | CTO, Security Team |
| HIGH | 4 hours | 7 days | Engineering Manager |
| MEDIUM | 1 business day | 30 days | Team Lead |
| LOW | Best effort | 90 days | Team Backlog |

## Remediation Process

1. **Automated Detection:** Daily scan creates GitHub issue
2. **Triage:** Security team reviews within SLA response time
3. **Prioritization:** Assign to sprint based on severity
4. **Remediation:** Update dependency or apply mitigation
5. **Verification:** Re-scan to confirm fix
6. **Documentation:** Update CHANGELOG.md with security fix

## Acceptable Risk

In rare cases, vulnerabilities may be accepted (not fixed) if:
- Not applicable to our use case (unused code path)
- No patch available and mitigations in place
- Risk is acceptable given business context

**Process:**
1. Document in `.cargo/audit.toml` with justification
2. Requires approval from CTO + Security Team
3. Review quarterly for status update
4. Monitor for patches

## Reporting

- **Weekly:** Summary to engineering team
- **Monthly:** Report to leadership (vulnerability count, SLA compliance)
- **Quarterly:** Compliance audit (PCI-DSS 6.2, SOX)
```

## Testing Plan

### Functional Testing

1. **Test cargo audit fails on vulnerable dependencies:**
   ```bash
   # Temporarily add vulnerable dependency to Cargo.toml
   # [dependencies]
   # time = "0.1.0"  # Known CVE: RUSTSEC-2020-0071

   # Run workflow - should fail
   git add Cargo.toml && git commit -m "test: add vulnerable dep"
   git push origin test-vulnerability-scan

   # Check CI fails with cargo audit error
   # Then revert: git revert HEAD
   ```

2. **Test Trivy catches container vulnerabilities:**
   ```bash
   # Use base image with known vulnerabilities for testing
   # Dockerfile: FROM debian:10  # EOL, many CVEs

   # Build and scan
   docker build -t test-vuln .
   trivy image --severity HIGH,CRITICAL test-vuln

   # Should report vulnerabilities
   ```

3. **Test scheduled scan workflow:**
   ```bash
   # Manually trigger scheduled workflow
   gh workflow run security-scan.yaml

   # Check for created issue if vulnerabilities found
   gh issue list --label security,automated
   ```

### Integration Testing

- [ ] CI fails on CRITICAL/HIGH vulnerabilities in dependencies
- [ ] CI fails on CRITICAL/HIGH vulnerabilities in container images
- [ ] Scan results uploaded to GitHub Security tab
- [ ] JSON reports uploaded as artifacts
- [ ] Scheduled scan runs successfully
- [ ] GitHub issue created for new vulnerabilities

## Documentation Updates

Required documentation:

1. **docs/security/VULNERABILITY_MANAGEMENT.md** (NEW) - Policy and SLAs
2. **docs/development/contributing.md** - Add note about vulnerability scanning
3. **docs/operations/security.md** - Document scanning process
4. **SECURITY.md** (NEW) - Security policy with vulnerability disclosure
5. **README.md** - Add security scanning badge
6. **CHANGELOG.md** - Document vulnerability scanning implementation

### Security Badge for README

```markdown
## Security

[![Security Audit](https://github.com/firestoned/bindy/actions/workflows/security-scan.yaml/badge.svg)](https://github.com/firestoned/bindy/actions/workflows/security-scan.yaml)

This project uses automated vulnerability scanning:
- Daily dependency audits with `cargo audit`
- Container image scanning with Trivy
- See [SECURITY.md](SECURITY.md) for our security policy
```

## Success Criteria

- [ ] `cargo audit` integrated into all workflows (main, pr, release)
- [ ] Trivy container scanning integrated into docker workflows
- [ ] Scheduled daily scans running
- [ ] CRITICAL/HIGH vulnerabilities fail builds
- [ ] Scan reports uploaded to GitHub Security tab
- [ ] Automated issue creation for new vulnerabilities
- [ ] Vulnerability management policy documented
- [ ] Remediation SLAs defined
- [ ] All current vulnerabilities remediated before enforcement
- [ ] Security badge added to README
- [ ] SECURITY.md created with disclosure policy

## Rollout Plan

**Week 1:**
- Day 1-2: Add cargo audit to workflows (warning only, don't fail)
- Day 3-4: Add Trivy scanning (warning only)
- Day 5: Create scheduled scan workflow

**Week 2:**
- Day 1: Audit all findings from Week 1
- Day 2-4: Remediate existing CRITICAL/HIGH vulnerabilities
- Day 5: Enable failure on CRITICAL/HIGH (enforcement)

**Week 3:**
- Day 1: Document vulnerability management policy
- Day 2-3: Create SECURITY.md and update documentation
- Day 4-5: Monitor for false positives, tune configuration

**Week 4+:**
- Monitor daily scans
- Respond to issues within SLA
- Monthly compliance report

## Initial Vulnerability Baseline

Before enforcing failures, create baseline report:

```bash
# Run scans manually
cargo audit --json > baseline-cargo-audit.json
docker build -t ghcr.io/firestoned/bindy:baseline .
trivy image --format json --output baseline-trivy.json ghcr.io/firestoned/bindy:baseline

# Commit baseline reports (for compliance)
git add baseline-*.json
git commit -m "docs: vulnerability baseline before enforcement"
```

**Document in CHANGELOG.md:**
```markdown
## [YYYY-MM-DD] - Vulnerability Scanning Enforcement

**Security Enhancement:**

Automated vulnerability scanning now enforced in CI/CD:

**Added:**
- cargo audit for Rust dependency scanning (fails on HIGH/CRITICAL)
- Trivy for container image scanning (fails on HIGH/CRITICAL)
- Daily scheduled scans with automated issue creation
- Vulnerability management policy with remediation SLAs

**Baseline:** X vulnerabilities found and remediated before enforcement
**Compliance:** Required for PCI-DSS 6.2

See docs/security/VULNERABILITY_MANAGEMENT.md for policy details.
```

## Compliance Attestation

Once complete, update compliance documentation:

**File:** `docs/compliance/CONTROLS.md`
```markdown
### PCI-DSS 6.2 - Vulnerability Management

**Control:** Vulnerability management program with regular scanning

**Implementation:**
- Automated dependency scanning on every build (cargo audit)
- Container image scanning on every build (Trivy)
- Daily scheduled scans for continuous monitoring
- Defined remediation SLAs by severity
- Scan results archived for 90 days (audit trail)

**Evidence:**
- CI/CD workflow configurations
- GitHub Security tab with scan results
- Issue tracker showing remediation activities
- Scan artifact archives

**Status:** ✅ Implemented (YYYY-MM-DD)
```

## Related Issues

- Blocks: PCI-DSS compliance certification
- Blocks: SOX IT controls certification
- Related: #TBD (Dependency license scanning)
- Related: #TBD (SBOM generation) - Already implemented

## References

- PCI-DSS v4.0: Requirement 6.2 - Vulnerability management program
- cargo-audit: https://github.com/rustsec/rustsec/tree/main/cargo-audit
- Trivy: https://github.com/aquasecurity/trivy
- RustSec Advisory Database: https://rustsec.org/
- GitHub Security: https://docs.github.com/en/code-security
